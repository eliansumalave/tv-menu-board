<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Menu Board - Full Scale</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto:wght@400;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-image: url('background.png'); 
            --primary-orange: #FF6600;
        }

        /* 1. Fondo negro total y centrado del contenido */
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden; 
            background-color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Roboto', sans-serif;
        }

        /* 2. El "Lienzo" de 1920x1080 */
        #main-canvas {
            width: 1920px;
            height: 1080px;
            position: relative;
            overflow: hidden;
            background-image: var(--bg-image);
            background-size: cover;
            flex-shrink: 0; 
            transform-origin: center center; 
        }

        .background-layer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 1;
        }

        .scroll-window {
            position: absolute;
            top: 20px;
            left: 680px;
            width: 1220px; 
            height: 1000px; 
            overflow: hidden;
            z-index: 2;
            /* Suavizado en los bordes superior e inferior */
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
            mask-image: linear-gradient(to bottom, transparent 0%, black 5%, black 95%, transparent 100%);
        }

        #scroll-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            position: relative;
            top: 0;
            /* Importante para la animación */
            will-change: transform;
        }

        .card {
            background: white;
            border-radius: 25px;
            padding: 25px;
            height: 480px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            box-sizing: border-box;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Clase para tarjetas de relleno invisibles */
        .card.hidden-spacer {
            visibility: hidden;
            background: transparent;
            box-shadow: none;
        }

        .card img { height: 280px; width: 100%; object-fit: contain; }
        .product-name { 
            overflow: hidden;
            align-content: center;
            height: 75px;
            font-size: 1.8rem; 
            font-weight: 900;
            color: #333;
            text-align: center; 
        }
        
        .price-ref { font-size: 2.5rem; font-weight: 900; color: #e65100; }
        .price-ref span { font-size: 1.2rem; color: #666; font-weight: normal; }
        .price-divisa { font-size: 1.4rem; font-weight: 700; color: #0277bd; text-align: center;}

        .side-image {
            position: absolute;
            bottom: 0; left: 0;
            object-fit: cover;
            z-index: 3;
        }
    </style>
</head>
<body>

    <div id="main-canvas">
        <div class="background-layer"></div>
        <img class="side-image" src="carniceria.png">
        <div class="scroll-window">
            <div id="scroll-container"></div>
        </div>
    </div>

    <script>
        /* SCRIPT DE ESCALADO AUTOMÁTICO */
        function scaleMenu() {
            const canvas = document.getElementById('main-canvas');
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const scaleX = windowWidth / 1920;
            const scaleY = windowHeight / 1080;
            const scale = Math.min(scaleX, scaleY);
            canvas.style.transform = `scale(${scale})`;
        }

        window.addEventListener('resize', scaleMenu);
        scaleMenu(); 

        /* LÓGICA DE DATOS */
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQdYJo8hW_1GmjLp9NQ4lT3jPU-Q0fqghtzMp3ypnWbgLILR1j-NYxqarjlEWPPy4_fozgD-A-DER_U/pub?gid=0&single=true&output=csv";
        const CONFIG_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRpYcutQnWmMA4HQHTf0Bo_qwK6al5zp-m4QdgaXw4sNOO7jIFJ2-uKtzX3645UfvsIBp1P2BXmz38Z/pub?gid=0&single=true&output=csv";
        const scrollContainer = document.getElementById('scroll-container');

        let scrollSpeed = 1.5; // Slightly slower default for smoothness
        let animationFrameId;
        let singleSetHeight = 0;
        let currentScroll = 0;

        async function loadConfig() {
            try {
                const response = await fetch(CONFIG_URL);
                const text = await response.text();
                const lines = text.split('\n');
                lines.forEach(line => {
                    const [key, value] = line.split(',');
                    if (key === 'scroll') scrollSpeed = parseFloat(value) || scrollSpeed;
                });
            } catch (e) { console.warn("No se pudo cargar la configuración", e); }
        }

        async function init() {
            await loadConfig();
            try {
                const response = await fetch(CSV_URL);
                const text = await response.text();
                let products = csvToJson(text);
                
                // 1. FILLER LOGIC: Add invisible items to complete the row
                // This prevents the "misaligned" grid look.
                const itemsPerRow = 4;
                const remainder = products.length % itemsPerRow;
                if (remainder !== 0) {
                    const itemsToAdd = itemsPerRow - remainder;
                    for (let i = 0; i < itemsToAdd; i++) {
                        products.push({ isSpacer: true });
                    }
                }

                // Stop previous animation before rebuilding
                if (animationFrameId) cancelAnimationFrame(animationFrameId);

                // Clear container
                scrollContainer.innerHTML = ''; 

                // 2. RENDER LOGIC
                // Render FIRST set
                renderItems(products);
                
                // Measure the precise height of one full set including the gap
                // We assume there is a row-gap. The distance to the start of the next set
                // is the current height + the grid row gap.
                const style = window.getComputedStyle(scrollContainer);
                const rowGap = parseFloat(style.getPropertyValue('row-gap')) || 20; 
                singleSetHeight = scrollContainer.scrollHeight + rowGap;

                // Render SECOND set (Duplicate)
                renderItems(products);

                // Start scrolling
                // Reset scroll position to 0 to avoid visual glitches on reload
                currentScroll = 0;
                startInfiniteScroll();

            } catch (e) { console.error("Error cargando CSV", e); }
        }

        function renderItems(products) {
            products.forEach(p => {
                let html = '';
                if (p.isSpacer) {
                    // Render an invisible card to hold the grid space
                    html = `<div class="card hidden-spacer"></div>`;
                } else {
                    html = `
                        <div class="card">
                            <img src="${p.imagen}" onerror="this.style.display='none'">
                            <div class="product-name">${p.nombre}</div>
                            <div>
                                <div class="price-ref"><span>REF</span> $${p.ref}</div>
                                <div class="price-divisa">Divisa $${p.divisa}</div>
                            </div>
                        </div>`;
                }
                scrollContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        function startInfiniteScroll() {
            function step() {
                currentScroll -= scrollSpeed;
                
                // 3. SMOOTH LOOP LOGIC
                // Instead of offsetHeight / 2, we check against the measured singleSetHeight
                if (Math.abs(currentScroll) >= singleSetHeight) {
                    // We add the height instead of setting to 0 to keep sub-pixel smoothness
                    // This prevents the tiny "jump" if speed is a decimal like 1.5
                    currentScroll += singleSetHeight;
                }
                
                scrollContainer.style.transform = `translateY(${currentScroll}px)`;
                animationFrameId = requestAnimationFrame(step);
            }
            animationFrameId = requestAnimationFrame(step);
        }

        function csvToJson(csv) {
            const lines = csv.split('\n');
            return lines.slice(1).map(line => {
                const cols = line.split(',');
                // Simple safety check to ensure line has data
                if(cols.length < 3) return null;
                return { 
                    nombre: cols[0]?.trim(), 
                    ref: cols[1]?.trim(), 
                    divisa: cols[2]?.trim(), 
                    imagen: cols[3]?.trim() 
                };
            }).filter(p => p && p.nombre);
        }

        init();
        // Updated interval to prevent memory leaks with animation frames
        setInterval(init, 60000); 
    </script>
</body>
</html>